---
layout: post
title: CMake入门记录(1)：初学Cmake
categories: [coding]
modify_date: 2016-09-04 14:00:00 +0800
---

近期在开发多平台SDK，难免会涉及到Linux下的编译，一扯上Linux下的编译，Makefile就少不了。但作为一直在Windows下VS的IDE开发下的同学，只会一些简单gcc编译命令，Makefile也就停留在HelloWorld阶段。。。  

## 1. 工具选择
现在必须涉及较多代码的编译，涉及到动态库、静态库、多平台，如果手动写Makefile肯定学习成本太高、效率太低。于是在网上开始搜索，发现了CMake。  
CMake是一个跨平台编译工具，能够自动生成Makefile以及不同IDE的项目文件，初看下来操作也相对简单，主要是写CMakeLists.txt。

实际在搜索中，发现自动生成Makefile工具的主要有CMake和automake，但感觉automake（需要写Makefile.am）操作太繁琐，并且初看下来跨平台需求选CMake更好，于是便开始了CMake学习。

* [C实战：项目构建Make,Automake,CMake](http://blog.csdn.net/dc_726/article/details/48978849)  
* [cmake与autoconf+automake的对比](http://blog.csdn.net/cnsword/article/details/7542696)  
* [CMake Tutorial](https://cmake.org/cmake-tutorial/)  
* [GNU Autotools的使用方法](http://blog.csdn.net/scucj/article/details/6079052)  
* [autotools工具介绍](http://blog.csdn.net/suer0101/article/details/7591946)

## 2. 编译初解
gcc编译，经过一些折磨，算是有点一点了解。编译目标文件主要是弄清楚目标文件依赖，编译过程中添加各种选项：  
* 指定目标文件名 `-o`  
* 警告选项 `-W`，常见`-Wall`  
* 优化选项 `-O`，常见`-O2`  
* 指定包好路径 `-I`（大写i）  
* 指定了解路径 `-L`(大写l)  
* 指定了解库 `-l`（小写l）  
* 添加宏定义 `-D`

比如：

```bash
gcc hello.c -I./include -L./lib -lutil -o hello
```

默认找动态库`libutil.so`，添加`-static`，则指定找静态库`libutil.a`。

### 2.1 静态库目标文件包含问题
生成的静态库需要包含所有依赖的目标文件：  
* Windows下lib文件包含obj文件  
* Linux下a文件包含o文件

#### 2.1.1 Windows下静态库包含文件的查看
Windows下使用`/Microsoft Visual Studio 14.0/VC/bin/lib.exe`工具可以查看

#### 2.1.2 Linux下静态库包含文件的查看
Linux下使用`ar`名利查看静态库包含的目标文件  
使用`nm`命令查看静态库和动态库包含的函数  
使用`ldd`命令查看动态库依赖

```bash
ar -t libutil.a
nm libutil.so | grep PrintHello
ldd libutil.so
```

### 2.2 静态库依赖顺序问题
在这上面踩过坑，折腾了一些时间。。。  
编出出现`undefined reference to xxx`错误一般就是gcc链接库的依赖顺序导致，被依赖的库应该放到后面，也就是越是底层的库，越往后面放。

## 3. CMake编译

参考文献：  

* [CMake 入门/加入编译选项](https://zh.wikibooks.org/zh-cn/CMake_%E5%85%A5%E9%96%80/%E5%8A%A0%E5%85%A5%E7%B7%A8%E8%AD%AF%E9%81%B8%E9%A0%85)  
* [CMake 用法导览](http://www.cnblogs.com/coderfenghc/archive/2013/01/20/2846621.html)
